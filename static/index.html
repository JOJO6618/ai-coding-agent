<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>AI Agent System</title>
        
        <!-- Vue 3 CDN -->
        <script src="https://unpkg.com/vue@3.3.4/dist/vue.global.prod.js"></script>
        
        <!-- Socket.IO CDN -->
        <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.6.1/dist/socket.io.min.js"></script>
        
        <!-- Marked.js for Markdown -->
        <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
        
        <!-- Prism.js for code highlighting -->
        <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
        
        <!-- KaTeX for LaTeX (Êó†deferÔºåÂêåÊ≠•Âä†ËΩΩ) -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
        
        <!-- Custom CSS -->
        <link rel="stylesheet" href="/static/style.css">
</head>
    <body>
    <div id="app">
        <!-- Loading indicator -->
        <div v-if="!isConnected && messages.length === 0" style="text-align: center; padding: 50px;">
            <h2>Ê≠£Âú®ËøûÊé•ÊúçÂä°Âô®...</h2>
            <p>Â¶ÇÊûúÈïøÊó∂Èó¥Êó†ÂìçÂ∫îÔºåËØ∑Âà∑Êñ∞È°µÈù¢</p>
        </div>
        
        <!-- Main UI (Âè™Âú®ËøûÊé•ÂêéÊòæÁ§∫) -->
        <template v-else>
            <!-- È°∂ÈÉ®Áä∂ÊÄÅÊ†è -->
            <header class="header">
                <div class="header-left">
                    <span class="logo">ü§ñ AI Agent</span>
                    <span class="project-path">{{ projectPath }}</span>
                </div>
                <div class="header-right">
                    <span class="thinking-mode">{{ thinkingMode }}</span>
                    <span class="connection-status" :class="{ connected: isConnected }">
                        <span class="status-dot" :class="{ active: isConnected }"></span>
                        {{ isConnected ? 'Â∑≤ËøûÊé•' : 'Êú™ËøûÊé•' }}
                    </span>
                </div>
            </header>

            <div class="main-container">
                <!-- Êñ∞Â¢ûÔºöÂØπËØùÂéÜÂè≤‰æßËæπÊ†èÔºàÊúÄÂ∑¶‰æßÔºâ -->
                <aside class="conversation-sidebar" :class="{ collapsed: sidebarCollapsed }">
                    <div class="conversation-header">
                        <button @click="createNewConversation" class="new-conversation-btn" v-if="!sidebarCollapsed">
                            <span class="btn-icon">+</span>
                            <span class="btn-text">Êñ∞Âª∫ÂØπËØù</span>
                        </button>
                        <button @click="toggleSidebar" class="toggle-sidebar-btn">
                            <span v-if="sidebarCollapsed">‚ò∞</span>
                            <span v-else>‚Üê</span>
                        </button>
                    </div>
                    
                    <template v-if="!sidebarCollapsed">
                        <div class="conversation-search">
                            <input v-model="searchQuery" 
                                   @input="searchConversations" 
                                   placeholder="ÊêúÁ¥¢ÂØπËØù..." 
                                   class="search-input">
                        </div>
                        
                        <div class="conversation-list">
                            <div v-if="conversationsLoading" class="loading-conversations">
                                Ê≠£Âú®Âä†ËΩΩ...
                            </div>
                            <div v-else-if="conversations.length === 0" class="no-conversations">
                                ÊöÇÊó†ÂØπËØùËÆ∞ÂΩï
                            </div>
                            <div v-else>
                                <div v-for="conv in conversations" 
                                     :key="conv.id" 
                                     class="conversation-item"
                                     :class="{ active: conv.id === currentConversationId }"
                                     @click="loadConversation(conv.id)">
                                    <div class="conversation-title">{{ conv.title }}</div>
                                    <div class="conversation-meta">
                                        <span class="conversation-time">{{ formatTime(conv.updated_at) }}</span>
                                        <span class="conversation-counts">
                                            {{ conv.total_messages }}Êù°Ê∂àÊÅØ
                                            <span v-if="conv.total_tools > 0"> ¬∑ {{ conv.total_tools }}Â∑•ÂÖ∑</span>
                                        </span>
                                    </div>
                                    <div class="conversation-actions" @click.stop>
                                        <button @click="deleteConversation(conv.id)" 
                                                class="delete-conversation-btn"
                                                title="Âà†Èô§ÂØπËØù">
                                            √ó
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div v-if="hasMoreConversations" class="load-more">
                                <button @click="loadMoreConversations" 
                                        :disabled="loadingMoreConversations" 
                                        class="load-more-btn">
                                    {{ loadingMoreConversations ? 'ËΩΩÂÖ•‰∏≠...' : 'Âä†ËΩΩÊõ¥Â§ö' }}
                                </button>
                            </div>
                        </div>
                    </template>
                </aside>

                <!-- Â∑¶‰æßÊñá‰ª∂Ê†ë -->
                <aside class="sidebar left-sidebar" :style="{ width: leftWidth + 'px' }">
                    <div class="sidebar-header">
                        <h3>üìÅ È°πÁõÆÊñá‰ª∂</h3>
                    </div>
                    <div class="file-tree">
                        <div v-for="file in fileTree" :key="file.path" class="file-item">
                            <span v-if="file.type === 'folder'" class="folder">
                                üìÇ {{ file.name }}
                            </span>
                            <span v-else class="file">
                                üìÑ {{ file.name }}
                                <span v-if="file.annotation" class="annotation">
                                    {{ file.annotation }}
                                </span>
                            </span>
                        </div>
                    </div>
                </aside>
                
                <!-- Â∑¶‰æßÊãñÊãΩÊâãÊüÑ -->
                <div class="resize-handle" @mousedown="startResize('left', $event)"></div>

                <!-- ‰∏≠Èó¥ËÅäÂ§©Âå∫Âüü -->
                <main class="chat-container">
                    <!-- ÂΩìÂâçÂØπËØù‰ø°ÊÅØÊ†è -->
                    <div class="current-conversation-info" v-if="currentConversationTitle">
                        <span class="conversation-title-display">{{ currentConversationTitle }}</span>
                        <span class="conversation-stats">
                            <span class="message-count">{{ messages.length }}Êù°Ê∂àÊÅØ</span>
                        </span>
                    </div>
                    
                    <!-- TokenÂå∫ÂüüÂåÖË£ÖÂô® -->
                    <div class="token-wrapper" v-if="currentConversationId">
                        <!-- TokenÁªüËÆ°ÊòæÁ§∫Èù¢Êùø -->
                        <div class="token-display-panel" :class="{ collapsed: tokenPanelCollapsed }">
                            <div class="token-panel-content">
                                <div class="token-stats">
                                    <div class="token-item">
                                        <span class="token-label">ÂΩìÂâç‰∏ä‰∏ãÊñá</span>
                                        <span class="token-value current">{{ formatTokenCount(currentContextTokens || 0) }}</span>
                                    </div>
                                    
                                    <div class="token-separator"></div>
                                    
                                    <div class="token-item">
                                        <span class="token-label">Á¥ØËÆ°ËæìÂÖ•</span>
                                        <span class="token-value input">{{ formatTokenCount(currentConversationTokens.cumulative_input_tokens || 0) }}</span>
                                    </div>
                                    
                                    <div class="token-item">
                                        <span class="token-label">Á¥ØËÆ°ËæìÂá∫</span>
                                        <span class="token-value output">{{ formatTokenCount(currentConversationTokens.cumulative_output_tokens || 0) }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Áã¨Á´ãÁöÑÂàáÊç¢ÊåâÈíÆ -->
                        <button @click="toggleTokenPanel" class="token-toggle-btn" :class="{ collapsed: tokenPanelCollapsed }">
                            <span v-if="!tokenPanelCollapsed">‚ñ≤</span>
                            <span v-else>‚ñº</span>
                        </button>
                    </div>
                    
                    <div class="messages-area" ref="messagesArea">
                        <div v-for="(msg, index) in messages" :key="index" class="message-block">
                            
                            <!-- Áî®Êà∑Ê∂àÊÅØ -->
                            <div v-if="msg.role === 'user'" class="user-message">
                                <div class="message-header">üë§ Áî®Êà∑</div>
                                <div class="message-text">{{ msg.content }}</div>
                            </div>
                            
                            <!-- AIÊ∂àÊÅØ -->
                            <div v-else-if="msg.role === 'assistant'" class="assistant-message">
                                <div class="message-header">ü§ñ AI Assistant</div>
                                
                                <!-- ÊåâÈ°∫Â∫èÊòæÁ§∫ÊâÄÊúâactions -->
                                <div v-for="(action, actionIndex) in msg.actions" 
                                :key="action.id"
                                class="action-item"
                                :class="{
                                    'streaming-content': action.streaming,
                                    'completed-tool': action.type === 'tool' && !action.streaming,
                                    'immediate-show': action.streaming || action.type === 'text'
                                }">
                                    
                                    <!-- ÊÄùËÄÉÂùó -->
                                    <div v-if="action.type === 'thinking'" 
                                         class="collapsible-block thinking-block"
                                         :class="{ expanded: expandedBlocks.has(`${index}-thinking-${actionIndex}`) }">
                                        <div class="collapsible-header" @click="toggleBlock(`${index}-thinking-${actionIndex}`)">
                                            <div class="arrow"></div>
                                            <div class="status-icon">
                                                <span class="thinking-icon" :class="{ 'thinking-animation': action.streaming }">üß†</span>
                                            </div>
                                            <span class="status-text">{{ action.streaming ? 'Ê≠£Âú®ÊÄùËÄÉ...' : 'ÊÄùËÄÉËøáÁ®ã' }}</span>
                                        </div>
                                        <div class="collapsible-content">
                                            <div class="content-inner thinking-content">
                                                {{ action.content }}
                                            </div>
                                        </div>
                                        <div v-if="action.streaming" class="progress-indicator"></div>
                                    </div>
                                    
                                    <!-- ÊñáÊú¨ËæìÂá∫Âùó -->
                                    <div v-else-if="action.type === 'text'" class="text-output">
                                        <div class="text-content" 
                                            :class="{ 'streaming-text': action.streaming }">
                                            <!-- ÊµÅÂºèÔºöÂÆûÊó∂Ê∏≤Êüìmarkdown‰ΩÜ‰∏çÂåÖË£Ö‰ª£Á†ÅÂùó -->
                                            <div v-if="action.streaming" v-html="renderMarkdown(action.content, true)"></div>
                                            <!-- ÂÆåÊàêÔºöÂÆåÊï¥Ê∏≤ÊüìÂåÖÂê´‰ª£Á†ÅÂùóÂåÖË£Ö -->
                                            <div v-else v-html="renderMarkdown(action.content, false)"></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Â∑•ÂÖ∑ÂùóÔºà‰øÆÂ§çÁâàÔºâ -->
                                    <div v-else-if="action.type === 'tool'" 
                                         class="collapsible-block tool-block"
                                         :class="{ 
                                             expanded: expandedBlocks.has(`${index}-tool-${actionIndex}`),
                                             processing: action.tool.status === 'preparing' || action.tool.status === 'running',
                                             completed: action.tool.status === 'completed'
                                         }">
                                        <div class="collapsible-header" @click="toggleBlock(`${index}-tool-${actionIndex}`)">
                                            <div class="arrow"></div>
                                            <div class="status-icon">
                                                <!-- ‰øÆÂ§çÔºö‰º†ÈÄíÂÆåÊï¥ÁöÑtoolÂØπË±° -->
                                                <span class="tool-icon"
                                                      :class="getToolAnimationClass(action.tool)">
                                                    {{ getToolIcon(action.tool) }}
                                                </span>
                                            </div>
                                            <span class="status-text">
                                                {{ getToolStatusText(action.tool) }}
                                            </span>
                                            <span class="tool-desc">{{ getToolDescription(action.tool) }}</span>
                                        </div>
                                        <div class="collapsible-content">
                                            <div class="content-inner">
                                                <!-- Ê†πÊçÆÂ∑•ÂÖ∑Á±ªÂûãÊòæÁ§∫‰∏çÂêåÂÜÖÂÆπ -->
                                                <div v-if="action.tool.name === 'web_search' && action.tool.result">
                                                    <div v-for="item in action.tool.result.results" :key="item.url" class="search-result">
                                                        <h4>{{ item.title }}</h4>
                                                        <p>{{ item.snippet }}</p>
                                                        <a :href="item.url" target="_blank">{{ item.url }}</a>
                                                    </div>
                                                </div>
                                                <div v-else-if="action.tool.name === 'run_python' && action.tool.result">
                                                    <div class="code-block">
                                                        <div class="code-label">‰ª£Á†ÅÔºö</div>
                                                        <pre><code class="language-python">{{ action.tool.result.code || action.tool.arguments.code }}</code></pre>
                                                    </div>
                                                    <div v-if="action.tool.result.output" class="output-block">
                                                        <div class="output-label">ËæìÂá∫Ôºö</div>
                                                        <pre>{{ action.tool.result.output }}</pre>
                                                    </div>
                                                </div>
                                                <div v-else>
                                                    <pre>{{ JSON.stringify(action.tool.result || action.tool.arguments, null, 2) }}</pre>
                                                </div>
                                            </div>
                                        </div>
                                        <!-- ‰øÆÂ§çÔºöÂè™Âú®runningÁä∂ÊÄÅÊòæÁ§∫ËøõÂ∫¶Êù° -->
                                        <!-- Âè™Âú®ÊµÅÂºèÊ∂àÊÅØÊúüÈó¥‰∏îÂ∑•ÂÖ∑ËøêË°åÊó∂ÊòæÁ§∫ËøõÂ∫¶Êù° -->
                                        <div v-if="streamingMessage && (action.tool.status === 'preparing' || action.tool.status === 'running')" 
                                        class="progress-indicator"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Á≥ªÁªüÊ∂àÊÅØ -->
                            <div v-else class="system-message">
                                {{ msg.content }}
                            </div>
                        </div>
                    </div>

                    <!-- ËæìÂÖ•Âå∫Âüü -->
                    <div class="input-area">
                        <div class="input-wrapper">
                            <textarea 
                                v-model="inputMessage" 
                                @keydown.enter.ctrl="sendMessage"
                                placeholder="ËæìÂÖ•Ê∂àÊÅØ... (Ctrl+Enter ÂèëÈÄÅ)"
                                class="message-input"
                                :disabled="!isConnected || streamingMessage"
                                rows="3">
                            </textarea>
                            <div class="input-actions">
                                <button @click="sendMessage" 
                                        :disabled="!isConnected || !inputMessage.trim() || streamingMessage" 
                                        class="btn send-btn">
                                    {{ streamingMessage ? 'Â§ÑÁêÜ‰∏≠...' : 'ÂèëÈÄÅ' }}
                                </button>
                                <button @click="stopTask" 
                                        v-if="streamingMessage"
                                        class="btn stop-btn">
                                    ÂÅúÊ≠¢
                                </button>
                                <button @click="clearChat" 
                                        v-if="!streamingMessage"
                                        class="btn clear-btn">Ê∏ÖÈô§</button>
                            </div>
                        </div>
                    </div>
                </main>
                
                <!-- Âè≥‰æßÊãñÊãΩÊâãÊüÑ -->
                <div class="resize-handle" @mousedown="startResize('right', $event)"></div>

                <!-- Âè≥‰æßËÅöÁÑ¶Êñá‰ª∂ -->
                <aside class="sidebar right-sidebar" :style="{ width: rightWidth + 'px' }">
                    <div class="sidebar-header">
                        <h3>üëÅÔ∏è ËÅöÁÑ¶Êñá‰ª∂ ({{ Object.keys(focusedFiles).length }}/3)</h3>
                    </div>
                    <div class="focused-files">
                        <div v-if="Object.keys(focusedFiles).length === 0" class="no-files">
                            ÊöÇÊó†ËÅöÁÑ¶Êñá‰ª∂
                        </div>
                        <div v-else class="file-tabs">
                            <div v-for="(file, path) in focusedFiles" :key="path" class="file-tab">
                                <div class="tab-header">
                                    <span class="file-name">{{ path.split('/').pop() }}</span>
                                    <span class="file-size">{{ (file.size / 1024).toFixed(1) }}KB</span>
                                </div>
                                <div class="file-content">
                                    <pre><code :class="getLanguageClass(path)">{{ file.content }}</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </aside>
            </div>
        </template>
    </div>
    <script>
        // ÂÖ®Â±ÄÂ§çÂà∂‰ª£Á†ÅÂùóÂáΩÊï∞
        function copyCodeBlock(blockId) {
            const codeElement = document.querySelector(`[data-code-id="${blockId}"]`);
            if (!codeElement) return;
            
            const button = document.querySelector(`[data-code="${blockId}"]`);
            
            // Â¶ÇÊûúÊ≠£Âú®ÊòæÁ§∫"Â∑≤Â§çÂà∂"Áä∂ÊÄÅÔºåÂøΩÁï•ÁÇπÂáª
            if (button.classList.contains('copied')) return;
            
            // ‰ΩøÁî®‰øùÂ≠òÁöÑÂéüÂßã‰ª£Á†ÅÂÜÖÂÆπ
            const codeContent = codeElement.dataset.originalCode || codeElement.textContent;
            
            // È¶ñÊ¨°ÁÇπÂáªÊó∂‰øùÂ≠òÂéüÂßãÂõæÊ†á
            if (!button.dataset.originalIcon) {
                button.dataset.originalIcon = button.textContent;
            }
            
            navigator.clipboard.writeText(codeContent).then(() => {
                button.textContent = '‚úì';
                button.classList.add('copied');
                
                setTimeout(() => {
                    // ‰ΩøÁî®‰øùÂ≠òÁöÑÂéüÂßãÂõæÊ†áÊÅ¢Â§ç
                    button.textContent = button.dataset.originalIcon || 'üìã';
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Â§çÂà∂Â§±Ë¥•:', err);
                // Âç≥‰ΩøÂ§±Ë¥•‰πüË¶ÅÊÅ¢Â§çÁä∂ÊÄÅ
                button.textContent = button.dataset.originalIcon || 'üìã';
                button.classList.remove('copied');
            });
        } 
        // ‰ΩøÁî®‰∫ã‰ª∂ÂßîÊâòÂ§ÑÁêÜÂ§çÂà∂ÊåâÈíÆÁÇπÂáª
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('copy-code-btn')) {
                const blockId = e.target.getAttribute('data-code');
                if (blockId) copyCodeBlock(blockId);
            }
        });
        </script>
    <!-- Âä†ËΩΩÂ∫îÁî®ËÑöÊú¨ -->
    <script src="/static/app.js"></script>
</body>
</html>
# AI Agent 系统技术文档 v2.0

## 系统概述

这是一个基于 DeepSeek 的智能自动化操作系统，能够在指定文件夹内执行各种任务。系统采用单终端架构，通过工具调用（Function Calling）实现文件操作、代码执行、网络搜索等功能。支持命令行（CLI）和Web两种运行模式。

## 核心设计理念

1. **对话连续性**：单次程序运行期间保持完整对话历史，包括工具调用结果
2. **思考模式优化**：两种模式平衡效率与深度（快速模式/思考模式）
3. **工具调用循环**：支持多轮工具调用直到任务完成
4. **文件备注同步**：文件和备注始终保持一一对应
5. **完整上下文传递**：确保API能看到完整的对话流程

## 运行模式

### 快速模式
- 不进行深度思考，直接响应
- 适合简单任务和快速交互
- 响应速度快，token消耗少

### 思考模式（智能思考）
- 每个新任务首次调用进行深度思考
- 同一任务的后续调用使用快速响应
- 思考内容会注入到后续对话中保持连贯性
- 平衡了深度理解和响应效率

## 文件结构和功能

### 入口文件
- **`main.py`** - 程序入口
  - 初始化系统
  - 选择运行模式（CLI/Web）
  - 选择思考模式（快速/思考）
  - 启动相应终端

### 配置文件
- **`config.py`** - 所有系统配置
  - API密钥（DeepSeek、Tavily）
  - 文件路径限制
  - 超时设置
  - 输出格式定义

### 核心模块 (`core/`)

#### `main_terminal.py` - 主终端（核心）
- **功能**：处理用户输入、管理对话流程
- **关键方法**：
  - `run()` - 主循环，处理用户输入
  - `handle_task()` - 处理任务，调用API
  - `handle_tool_call()` - 执行工具调用
  - `define_tools()` - 定义可用工具
  - `build_messages()` - 构建包含完整历史的消息列表
- **重要改进**：
  - 工具执行后立即保存结果到历史
  - 确保工具调用格式完整（包含id、type）

#### `web_terminal.py` - Web终端
- **功能**：继承MainTerminal，适配Web环境
- **特点**：
  - 禁用print输出（web_mode=True）
  - 提供状态查询接口
  - 支持WebSocket通信

#### `task_executor.py` - 任务执行器（已废弃）
- 原双终端架构的遗留，现在未使用

### 工具模块 (`modules/`)

#### `file_manager.py` - 文件操作
- **功能**：所有文件和文件夹操作
- **关键方法**：
  - `create_file()` - 创建文件
  - `delete_file()` - 删除文件（返回action标记）
  - `rename_file()` - 重命名（返回新旧路径）
  - `read_file()` - 读取文件内容
  - `modify_file()` - 修改文件（追加/替换/清空）

#### `search_engine.py` - 网络搜索
- **功能**：Tavily API搜索
- **关键方法**：
  - `search()` - 执行搜索
  - `search_with_summary()` - 搜索并格式化

#### `terminal_ops.py` - 终端操作
- **功能**：执行Python代码和终端命令
- **关键方法**：
  - `run_python_code()` - 执行Python代码
  - `run_command()` - 执行终端命令
- **注意**：所有Python命令使用`python3`

#### `memory_manager.py` - 记忆管理
- **功能**：管理主记忆和任务记忆
- **用途**：长期知识存储，不是对话记录

### 工具模块 (`utils/`)

#### `api_client.py` - API客户端（核心）
- **功能**：与DeepSeek API通信
- **关键方法**：
  - `chat_with_tools()` - 带工具调用的对话
  - `simple_chat()` - 简单对话（无工具）
  - `get_current_thinking_mode()` - 获取当前思考模式
- **思考模式逻辑**：
  - 快速模式：始终不思考
  - 思考模式：首次思考，后续快速
- **重要特性**：
  - 流式输出处理
  - 思考内容显示（💭标记）
  - 工具调用循环（最多20次）
  - 上下文传递（使用`<think>`标签）

#### `context_manager.py` - 上下文管理（已修复）
- **功能**：管理对话历史和文件备注
- **关键方法**：
  - `get_project_structure()` - 获取文件结构
  - `add_conversation()` - 添加所有类型的对话记录
  - `add_tool_result()` - 添加工具结果（专用方法）
  - `update_annotation()` - 更新文件备注
- **重要修复**：
  - 支持保存tool消息
  - 自动补全工具调用格式
  - 确保对话流程完整性

#### `logger.py` - 日志系统
- 记录错误和操作日志

### Web服务 (`web_server.py`)
- **功能**：提供Web界面服务
- **特点**：
  - Flask + SocketIO实现
  - 实时流式输出
  - 文件树动态更新
- **重要修复**：
  - 工具执行后立即保存结果
  - 确保完整的消息流传递

### 提示模板 (`prompts/`)
- **`main_system.txt`** - 主系统提示
- 其他文件可选使用

## 文件协作关系

### 对话流程（修复版）
```
用户输入(main_terminal) 
→ 构建消息(包含完整历史+系统提示) 
→ API调用(api_client) 
→ 工具执行(main_terminal.handle_tool_call) 
→ 保存工具结果到历史 ← 【关键修复点】
→ 具体操作(file_manager/search_engine等) 
→ 返回结果 
→ 继续或结束
```

### 消息流完整性
```
正确的消息流：
user → assistant(with tool_calls) → tool → assistant → tool → user → ...

每个消息都包含：
- role: 角色类型
- content: 内容
- tool_calls: 工具调用（assistant消息）
- tool_call_id: 工具调用ID（tool消息）
- name: 工具名称（tool消息）
```

### 思考模式流程
```
思考模式下的任务处理：
1. 新任务开始 → start_new_task()
2. 第一次调用 → thinking: enabled → 保存思考内容
3. 后续调用 → thinking: disabled + 注入之前的思考
4. 新任务开始 → 重置，回到步骤1
```

## 关键技术细节

### 工具调用格式
```python
# 完整的工具调用格式
{
    "id": "call_xxx",  # 唯一标识
    "type": "function",  # 类型
    "function": {
        "name": "tool_name",
        "arguments": "{...}"  # JSON字符串
    }
}
```

### 文件聚焦机制
- 最多同时聚焦3个文件
- 聚焦文件内容持续注入上下文
- 文件修改自动更新聚焦内容
- 删除/重命名自动处理聚焦状态

### 上下文大小管理
- 自动检查上下文使用率
- 聚焦文件单独注入（系统消息）
- 对话历史保留最近记录

## 常见问题解决

### 工具调用后无响应
**原因**：工具结果未保存到历史
**解决**：
1. 执行工具后立即调用 `add_tool_result()`
2. 确保工具调用包含完整格式（id、type）
3. `build_messages()` 正确恢复tool消息

### 思考内容与工具调用冲突
**原因**：DeepSeek模型在思考模式下直接调用工具
**解决**：使用智能思考模式，首次思考后切换到快速模式

### 文件备注不同步
**原因**：手动删除文件后备注残留
**解决**：`get_project_structure()` 自动清理无效备注

## 调试技巧

### 查看完整消息流
```python
# 在 build_messages() 后添加
print(json.dumps(messages, ensure_ascii=False, indent=2))
```

### 监控工具调用
Web模式下查看 `debug_stream.log` 文件

### 验证对话历史完整性
检查 `data/conversation_history.json` 是否包含tool消息

## 系统限制

1. **工具调用次数**：单任务最多20次迭代
2. **聚焦文件数量**：最多3个
3. **连续相同工具**：8次触发警告
4. **上下文长度**：受DeepSeek API限制

## 版本更新说明

### v2.0 主要改进
1. **修复工具调用中断**：确保工具结果保存到历史
2. **简化思考模式**：从三种模式简化为两种
3. **完善消息流**：支持完整的对话流程
4. **优化Web体验**：改进流式输出和状态更新

### 从 v1.x 升级注意事项
1. `thinking_mode` 和 `smart_thinking_mode` 合并为单一参数
2. 工具调用格式必须包含 id 和 type
3. 对话历史需要包含 tool 消息

## 最佳实践

1. **选择合适的模式**
   - 简单查询用快速模式
   - 复杂任务用思考模式

2. **管理聚焦文件**
   - 只聚焦频繁修改的文件
   - 及时取消不需要的聚焦

3. **监控系统状态**
   - 定期使用 `/status` 查看
   - 注意上下文使用率

4. **处理长任务**
   - 适时清理对话历史
   - 合理使用记忆系统

这个系统的核心优势在于完整的对话管理和智能的思考模式切换，确保了既能深度理解任务又能高效执行。